@model TravelAgencyService.Models.ViewModels.HomeViewModel
@{
    ViewData["Title"] = "Wanderlust Travel - Explore The World";
    Layout = "_Layout";
}

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<!-- Main Map Section -->
<section class="py-0" style="background: #f5f5f5; min-height: calc(100vh - 56px);">
    <div class="container-fluid p-0">
        <div class="row g-0" style="min-height: calc(100vh - 56px);">

            <!-- Left Sidebar - Filters + Trips List -->
            <div class="col-lg-4 col-xl-3" style="background: #fff; border-right: 1px solid #e0e0e0; height: calc(100vh - 56px); overflow-y: auto;">

                <!-- Search Header -->
                <div class="p-3 border-bottom" style="background: #fff;">
                    <div class="mb-3 position-relative">
                        <label class="form-label text-muted small fw-semibold mb-1">Where to?</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" id="quickSearch" class="form-control border-start-0 ps-0"
                                   placeholder="Search destinations..." autocomplete="off">
                        </div>
                        
                        <!-- Search Dropdown Results -->
                        <div id="searchDropdown" class="position-absolute w-100 bg-white border rounded-3 shadow-lg mt-1" 
                             style="z-index: 1050; max-height: 400px; overflow-y: auto; display: none;">
                        </div>
                    </div>

                    <!-- Filters Row -->
                    <div class="row g-2">
                        <!-- Package Type -->
                        <div class="col-12 mb-2">
                            <label class="form-label text-muted small fw-semibold mb-1">Package Type</label>
                            <select id="mapPackageFilter" class="form-select form-select-sm">
                                <option value="">All Types</option>
                                @foreach (var type in Enum.GetValues<TravelAgencyService.Models.PackageType>())
                                {
                                    <option value="@type">@type</option>
                                }
                            </select>
                        </div>
                        
                        <!-- Price Filter - Slider -->
                        <div class="col-12">
                            <label class="form-label text-muted small fw-semibold mb-1">
                                Max Price: <span class="text-primary fw-bold">$<span id="priceValue">10000</span></span>
                            </label>
                            <input type="range" id="mapPriceFilter" class="form-range" min="100" max="10000" step="100" value="10000">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">$100</small>
                                <small class="text-muted">$10,000</small>
                            </div>
                        </div>
                    </div>

                    <!-- Sale Filter -->
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="showOnSale">
                        <label class="form-check-label small" for="showOnSale">
                            <span class="badge bg-danger me-1">Sale</span> Show only discounted
                        </label>
                    </div>
                </div>

                <!-- Results Count -->
                <div class="p-2 border-bottom" style="background: #fafafa;">
                    <small class="text-muted">
                        <span id="resultsCount" class="fw-bold text-dark">@Model.AllTrips.Count</span> destinations found
                    </small>
                </div>

                <!-- Trips List -->
                <div id="tripsList" class="p-0">
                    @foreach (var trip in Model.AllTrips)
                    {
                        <div class="trip-item p-3 border-bottom"
                             data-trip-id="@trip.TripId"
                             data-lat="@trip.Latitude"
                             data-lng="@trip.Longitude"
                             style="cursor: pointer; transition: background 0.2s;">
                            <div class="d-flex">
                                <!-- Trip Image -->
                                <div class="flex-shrink-0 me-3" style="width: 100px; height: 80px;">
                                    @if (!string.IsNullOrEmpty(trip.MainImageUrl))
                                    {
                                        <img src="@trip.MainImageUrl"
                                             class="rounded"
                                             style="width: 100%; height: 100%; object-fit: cover;"
                                             alt="@trip.PackageName">
                                    }
                                    else
                                    {
                                        <div class="rounded d-flex align-items-center justify-content-center h-100"
                                             style="background: #e0e0e0;">
                                            <i class="bi bi-image text-muted"></i>
                                        </div>
                                    }
                                </div>

                                <!-- Trip Info -->
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1 fw-semibold" style="font-size: 0.95rem;">@trip.Destination</h6>
                                            <p class="mb-1 text-muted small">@trip.Country</p>
                                            <p class="mb-0 text-muted small">
                                                @trip.StartDate.ToString("dd MMM") - @trip.EndDate.ToString("dd MMM")
                                            </p>
                                        </div>
                                        <div class="text-end">
                                            @if (trip.IsOnSale && trip.OriginalPrice.HasValue)
                                            {
                                                <small class="text-muted text-decoration-line-through d-block">$@trip.OriginalPrice</small>
                                            }
                                            <span class="fw-bold" style="color: #1a73e8;">$@trip.Price</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Right - Map -->
            <div class="col-lg-8 col-xl-9 position-relative">
                <div id="tripMap" style="height: calc(100vh - 56px); width: 100%;"></div>

                <!-- Loading Overlay -->
                <div id="loadingOverlay" class="position-absolute top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center"
                     style="background: rgba(255,255,255,0.9); z-index: 1000;">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                        <p class="text-muted mb-0">Loading map...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Service Reviews Section -->
<section id="reviews-section" class="py-5" style="background: #fff;">
    <div class="container">
        <div class="text-center mb-5">
            <h2 class="fw-bold mb-2" style="color: #1a1a2e; font-size: 1.75rem;">
                What Users Think About Our Service
            </h2>
            <p class="text-muted">Real feedback from our valued customers</p>
        </div>

        @if (Model.ServiceReviews.Any())
        {
            <div class="row g-4 justify-content-center">
                @foreach (var review in Model.ServiceReviews)
                {
                    <div class="col-lg-4 col-md-6">
                        <div class="card h-100 border shadow-sm" style="border-radius: 12px;">
                            <div class="card-body p-4">
                                <!-- Rating -->
                                <div class="mb-3">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        <i class="bi bi-star@(i <= review.Rating ? "-fill" : "") text-warning"></i>
                                    }
                                </div>

                                <!-- Comment -->
                                <p class="text-dark mb-4" style="line-height: 1.7;">
                                    "@review.Comment"
                                </p>

                                <!-- User Info -->
                                <div class="d-flex align-items-center pt-3 border-top">
                                    <div class="me-3" style="width: 45px; height: 45px; border-radius: 50%; background: #1a73e8; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                        @review.UserName.Substring(0, 1).ToUpper()
                                    </div>
                                    <div>
                                        <div class="fw-semibold">@review.UserName</div>
                                        <small class="text-muted">@review.CreatedAt.ToString("MMM dd, yyyy")</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center py-4">
                <i class="bi bi-chat-left-text text-muted" style="font-size: 3rem; opacity: 0.3;"></i>
                <p class="text-muted mt-3">No reviews yet. Be the first to share your experience!</p>
            </div>
        }

        <!-- Add Review Button -->
        @if (User.Identity?.IsAuthenticated == true)
        {
            <div class="text-center mt-4">
                <a asp-controller="Review" asp-action="CreateServiceReview"
                   class="btn px-4 py-2"
                   style="background: #1a73e8; color: white; border-radius: 8px;">
                    <i class="bi bi-pencil-square me-2"></i>Share Your Experience
                </a>
            </div>
        }
        else
        {
            <div class="text-center mt-4">
                <a asp-controller="Account" asp-action="Login" class="btn btn-outline-secondary px-4 py-2" style="border-radius: 8px;">
                    <i class="bi bi-box-arrow-in-right me-2"></i>Login to Review
                </a>
            </div>
        }
    </div>
</section>

<!-- Footer -->
<footer style="background: #1a1a2e; color: #fff;">
    <div class="container py-5">
        <div class="row">
            <!-- About -->
            <div class="col-lg-6 mb-4 mb-lg-0">
                <h4 class="fw-bold mb-3">
                    <i class="bi bi-globe-americas me-2" style="color: #1a73e8;"></i>Wanderlust Travel
                </h4>
                <p class="text-secondary mb-4" style="line-height: 1.8; max-width: 400px;">
                    Your trusted partner in creating unforgettable travel experiences.
                    We specialize in curated travel packages that combine adventure,
                    comfort, and authentic cultural experiences.
                </p>
                <div class="d-flex gap-3">
                    <a href="#" class="text-secondary fs-5"><i class="bi bi-facebook"></i></a>
                    <a href="#" class="text-secondary fs-5"><i class="bi bi-instagram"></i></a>
                    <a href="#" class="text-secondary fs-5"><i class="bi bi-twitter-x"></i></a>
                    <a href="#" class="text-secondary fs-5"><i class="bi bi-linkedin"></i></a>
                </div>
            </div>

            <!-- Contact Info -->
            <div class="col-lg-6">
                <h5 class="fw-semibold mb-3">Contact Us</h5>
                <ul class="list-unstyled">
                    <li class="mb-3 d-flex align-items-start">
                        <i class="bi bi-geo-alt-fill me-3 mt-1" style="color: #1a73e8;"></i>
                        <span class="text-secondary">
                            123 Travel Street, Suite 456<br>
                            Tel Aviv, Israel 6100000
                        </span>
                    </li>
                    <li class="mb-3 d-flex align-items-center">
                        <i class="bi bi-telephone-fill me-3" style="color: #1a73e8;"></i>
                        <a href="tel:+972-3-123-4567" class="text-secondary text-decoration-none">
                            +972-3-123-4567
                        </a>
                    </li>
                    <li class="mb-3 d-flex align-items-center">
                        <i class="bi bi-envelope-fill me-3" style="color: #1a73e8;"></i>
                        <a href="mailto:TravelAgencyService@gmail.com" class="text-secondary text-decoration-none">
                            TravelAgencyService@gmail.com
                        </a>
                    </li>
                    <li class="d-flex align-items-center">
                        <i class="bi bi-clock-fill me-3" style="color: #1a73e8;"></i>
                        <span class="text-secondary">
                            Sun-Thu: 9:00 AM - 6:00 PM
                        </span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Bottom Footer -->
    <div class="border-top" style="border-color: #2a2a4e !important;">
        <div class="container py-3">
            <div class="row align-items-center">
                <div class="col-md-6 text-center text-md-start">
                    <small class="text-secondary">
                        © @DateTime.Now.Year Wanderlust Travel. All rights reserved.
                    </small>
                </div>
                <div class="col-md-6 text-center text-md-end mt-2 mt-md-0">
                    <small>
                        <a href="#" class="text-secondary text-decoration-none me-3">Privacy Policy</a>
                        <a href="#" class="text-secondary text-decoration-none me-3">Terms of Service</a>
                        <a href="#" class="text-secondary text-decoration-none">Refund Policy</a>
                    </small>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- Styles -->
<style>
    body {
        overflow-x: hidden;
    }
    
    .trip-item:hover {
        background: #f8f9fa !important;
    }
    
    .trip-item.active {
        background: #e3f2fd !important;
        border-left: 3px solid #1a73e8 !important;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #1a73e8;
        box-shadow: 0 0 0 0.2rem rgba(26, 115, 232, 0.15);
    }
    
    .form-check-input:checked {
        background-color: #1a73e8;
        border-color: #1a73e8;
    }
    
    .form-range::-webkit-slider-thumb {
        background: #1a73e8;
    }
    
    .form-range::-moz-range-thumb {
        background: #1a73e8;
    }

    /* Map Styles */
    .leaflet-popup-content-wrapper {
        border-radius: 12px !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15) !important;
        padding: 0 !important;
        overflow: hidden;
    }

    .leaflet-popup-content {
        margin: 0 !important;
        min-width: 280px;
    }

    .leaflet-popup-tip {
        background: #fff;
    }

    .leaflet-control-zoom {
        border: none !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
        border-radius: 8px !important;
        overflow: hidden;
    }

    .leaflet-control-zoom a {
        width: 32px !important;
        height: 32px !important;
        line-height: 32px !important;
        color: #333 !important;
        border: none !important;
    }

    .leaflet-control-zoom a:hover {
        background: #1a73e8 !important;
        color: white !important;
    }

    .custom-marker-icon {
        background: transparent;
        border: none;
    }

    /* Scrollbar for sidebar */
    .col-lg-4::-webkit-scrollbar,
    .col-xl-3::-webkit-scrollbar {
        width: 6px;
    }
    
    .col-lg-4::-webkit-scrollbar-track,
    .col-xl-3::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .col-lg-4::-webkit-scrollbar-thumb,
    .col-xl-3::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }

    footer a:hover {
        color: #1a73e8 !important;
    }

    /* Card hover */
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
    }
    
    /* Search dropdown */
    #searchDropdown::-webkit-scrollbar {
        width: 6px;
    }
    
    #searchDropdown::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    #searchDropdown::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }
</style>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Trip Data from server
    const tripsData = @Html.Raw(Json.Serialize(Model.AllTrips.Select(t => new {
        id = t.TripId,
        name = t.PackageName,
        destination = t.Destination,
        country = t.Country,
        latitude = t.Latitude,
        longitude = t.Longitude,
        price = t.Price,
        originalPrice = t.OriginalPrice,
        packageType = t.PackageType.ToString(),
        isOnSale = t.IsOnSale,
        availableRooms = t.AvailableRooms,
        rating = t.AverageRating,
        reviewCount = t.ReviewCount,
        imageUrl = t.MainImageUrl,
        startDate = t.StartDate.ToString("dd MMM"),
        endDate = t.EndDate.ToString("dd MMM")
    })));

    // Initialize Map
    const map = L.map('tripMap', {
        zoomControl: true,
        scrollWheelZoom: true,
        minZoom: 2,
        maxZoom: 18
    }).setView([35, 20], 4);

    // Map tiles - clean style like Google
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '© OpenStreetMap © CARTO',
        maxZoom: 18
    }).addTo(map);

    const markers = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        iconCreateFunction: function(cluster) {
            const count = cluster.getChildCount();
            return L.divIcon({
                html: `<div style="background: #1a73e8; color: white; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; font-weight: 600; box-shadow: 0 2px 10px rgba(0,0,0,0.3); border: 2px solid white; font-size: 13px;">${count}</div>`,
                className: 'custom-cluster-icon',
                iconSize: L.point(36, 36)
            });
        }
    });

    let allMarkers = [];
    let tripMarkerMap = {};
    const geocodeCache = {};

    // Geocode function
    async function geocodeLocation(destination, country) {
        const cacheKey = `${destination}, ${country}`;
        if (geocodeCache[cacheKey]) return geocodeCache[cacheKey];

        try {
            const query = encodeURIComponent(cacheKey);
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1`);
            const data = await response.json();
            
            if (data && data.length > 0) {
                const coords = { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                geocodeCache[cacheKey] = coords;
                return coords;
            }
        } catch (error) {
            console.error(`Geocoding failed for ${cacheKey}:`, error);
        }
        return null;
    }

    // Create popup content
    function createPopupContent(trip) {
        return `
            <div style="width: 280px;">
                ${trip.imageUrl ? `<img src="${trip.imageUrl}" style="width: 100%; height: 140px; object-fit: cover;">` : ''}
                <div style="padding: 16px;">
                    <h6 style="font-weight: 600; margin-bottom: 4px; color: #202124; font-size: 16px;">${trip.destination}</h6>
                    <p style="margin: 0 0 8px 0; color: #5f6368; font-size: 13px;">${trip.country}</p>
                    <p style="margin: 0 0 12px 0; color: #5f6368; font-size: 13px;">
                        ${trip.startDate} - ${trip.endDate}
                    </p>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                        <div>
                            ${trip.isOnSale && trip.originalPrice ? `
                                <small style="text-decoration: line-through; color: #9aa0a6; font-size: 12px;">$${trip.originalPrice}</small><br>
                            ` : ''}
                            <span style="font-size: 18px; font-weight: 600; color: #1a73e8;">$${trip.price}</span>
                        </div>
                        <a href="/Trip/Details/${trip.id}" style="background: #1a73e8; color: white; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-size: 13px; font-weight: 500;">
                            View Details
                        </a>
                    </div>
                </div>
            </div>
        `;
    }

    // Load markers
    async function loadMarkers() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.remove('d-none');
        overlay.classList.add('d-flex');
        
        for (const trip of tripsData) {
            let coords = trip.latitude && trip.longitude 
                ? { lat: trip.latitude, lon: trip.longitude }
                : await geocodeLocation(trip.destination, trip.country);
            
            if (coords) {
                const priceDisplay = `${trip.price}$`;
                const icon = L.divIcon({
                    html: `
                        <div style="background: white; padding: 4px 8px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-weight: 600; font-size: 12px; color: #202124; white-space: nowrap; border: 1px solid #e0e0e0;">
                            ${priceDisplay}
                        </div>
                    `,
                    className: 'custom-marker-icon',
                    iconSize: [60, 24],
                    iconAnchor: [30, 12]
                });

                const marker = L.marker([coords.lat, coords.lon], { icon: icon });
                marker.bindPopup(createPopupContent(trip), { maxWidth: 300 });
                marker.tripData = trip;
                marker.coords = coords;
                
                allMarkers.push(marker);
                tripMarkerMap[trip.id] = marker;
                markers.addLayer(marker);
            }
        }

        map.addLayer(markers);
        overlay.classList.add('d-none');
        overlay.classList.remove('d-flex');

        if (allMarkers.length > 0) {
            const group = new L.featureGroup(allMarkers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
    }

    // Filter function
    function filterTrips() {
        const searchQuery = document.getElementById('quickSearch').value.toLowerCase();
        const packageType = document.getElementById('mapPackageFilter').value;
        const maxPrice = parseInt(document.getElementById('mapPriceFilter').value);
        const showOnSaleOnly = document.getElementById('showOnSale').checked;

        let visibleCount = 0;
        markers.clearLayers();

        // Filter markers on map
        allMarkers.forEach(marker => {
            const trip = marker.tripData;
            let show = true;

            if (searchQuery && 
                !trip.destination.toLowerCase().includes(searchQuery) && 
                !trip.country.toLowerCase().includes(searchQuery) &&
                !trip.name.toLowerCase().includes(searchQuery)) {
                show = false;
            }
            if (packageType && trip.packageType !== packageType) show = false;
            if (trip.price > maxPrice) show = false;
            if (showOnSaleOnly && !trip.isOnSale) show = false;

            if (show) {
                markers.addLayer(marker);
                visibleCount++;
            }
        });

        // Filter trip list in sidebar
        document.querySelectorAll('.trip-item').forEach(item => {
            const tripId = parseInt(item.dataset.tripId);
            const trip = tripsData.find(t => t.id === tripId);
            
            if (trip) {
                let show = true;
                
                if (searchQuery && 
                    !trip.destination.toLowerCase().includes(searchQuery) && 
                    !trip.country.toLowerCase().includes(searchQuery) &&
                    !trip.name.toLowerCase().includes(searchQuery)) {
                    show = false;
                }
                if (packageType && trip.packageType !== packageType) show = false;
                if (trip.price > maxPrice) show = false;
                if (showOnSaleOnly && !trip.isOnSale) show = false;

                item.style.display = show ? 'block' : 'none';
            }
        });

        document.getElementById('resultsCount').textContent = visibleCount;
    }

    // Search Dropdown functionality
    const searchInput = document.getElementById('quickSearch');
    const searchDropdown = document.getElementById('searchDropdown');

    function showSearchResults(query = '') {
        let matchingTrips;
        
        if (query.length === 0) {
            // Show all trips when empty
            matchingTrips = tripsData.slice(0, 8);
        } else {
            // Filter by query
            matchingTrips = tripsData.filter(trip => 
                trip.destination.toLowerCase().includes(query) ||
                trip.country.toLowerCase().includes(query) ||
                trip.name.toLowerCase().includes(query)
            ).slice(0, 8);
        }

        if (matchingTrips.length > 0) {
            searchDropdown.innerHTML = matchingTrips.map(trip => `
                <div class="search-result-item p-2 border-bottom" data-trip-id="${trip.id}" style="cursor: pointer; transition: background 0.2s;">
                    <div class="d-flex align-items-center">
                        <div class="me-3" style="width: 60px; height: 45px; flex-shrink: 0;">
                            ${trip.imageUrl 
                                ? `<img src="${trip.imageUrl}" class="rounded" style="width: 100%; height: 100%; object-fit: cover;">` 
                                : `<div class="rounded bg-light d-flex align-items-center justify-content-center h-100"><i class="bi bi-image text-muted"></i></div>`
                            }
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-semibold" style="font-size: 0.9rem;">${trip.destination}</div>
                            <small class="text-muted">${trip.country} • ${trip.packageType}</small>
                        </div>
                        <div class="text-end">
                            ${trip.isOnSale ? `<small class="text-decoration-line-through text-muted d-block">$${trip.originalPrice}</small>` : ''}
                            <span class="fw-bold" style="color: #1a73e8;">$${trip.price}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            searchDropdown.style.display = 'block';
            attachSearchResultListeners();
        } else {
            searchDropdown.innerHTML = `
                <div class="p-3 text-center">
                    <i class="bi bi-search text-muted mb-2 d-block" style="font-size: 1.5rem;"></i>
                    <span class="text-muted">No destinations found for "${query}"</span>
                </div>
            `;
            searchDropdown.style.display = 'block';
        }
    }

    function attachSearchResultListeners() {
        document.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', function() {
                const tripId = parseInt(this.dataset.tripId);
                const marker = tripMarkerMap[tripId];
                const trip = tripsData.find(t => t.id === tripId);
                
                if (trip) {
                    searchInput.value = trip.destination;
                    searchDropdown.style.display = 'none';
                }
                
                if (marker && marker.coords) {
                    map.setView([marker.coords.lat, marker.coords.lon], 10);
                    marker.openPopup();
                }

                // Highlight in sidebar
                document.querySelectorAll('.trip-item').forEach(i => i.classList.remove('active'));
                const sidebarItem = document.querySelector(`.trip-item[data-trip-id="${tripId}"]`);
                if (sidebarItem) {
                    sidebarItem.classList.add('active');
                    sidebarItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                filterTrips();
            });

            item.addEventListener('mouseenter', function() {
                this.style.background = '#f0f7ff';
            });
            item.addEventListener('mouseleave', function() {
                this.style.background = 'white';
            });
        });
    }

    // Show dropdown on focus (show all options)
    searchInput.addEventListener('focus', function() {
        showSearchResults(this.value.toLowerCase().trim());
    });

    // Filter as user types
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        showSearchResults(query);
        filterTrips();
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchDropdown.contains(e.target)) {
            searchDropdown.style.display = 'none';
        }
    });

    // Keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            searchDropdown.style.display = 'none';
        }
    });

    // Click on trip item in sidebar
    document.querySelectorAll('.trip-item').forEach(item => {
        item.addEventListener('click', function() {
            const tripId = parseInt(this.dataset.tripId);
            const marker = tripMarkerMap[tripId];
            
            // Remove active from all items
            document.querySelectorAll('.trip-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            
            if (marker && marker.coords) {
                map.setView([marker.coords.lat, marker.coords.lon], 10);
                marker.openPopup();
            }
        });
    });

    // Price slider
    document.getElementById('mapPriceFilter').addEventListener('input', function() {
        document.getElementById('priceValue').textContent = this.value;
        filterTrips();
    });

    // Event listeners for other filters
    document.getElementById('mapPackageFilter').addEventListener('change', filterTrips);
    document.getElementById('showOnSale').addEventListener('change', filterTrips);

    // Load markers on page load
    loadMarkers();
});
</script>